// ================================
// SUNO STABLE V3 – PERFORMANCE OPTIMIZED
// ================================

class SunoEngine {

  constructor() {
    this.artistLock = null
    this.cache = new Map()
  }

  // ---------- RANDOM FAST ----------
  randomPick(arr){
    return arr[Math.floor(Math.random()*arr.length)]
  }

  randomTitle(){
    const words1 = ["Midnight","Neon","Silent","Golden","Falling","Crimson","Velvet"]
    const words2 = ["Dream","Echo","Light","Shadow","Fire","Sky","Rain"]
    return this.randomPick(words1)+" "+this.randomPick(words2)
  }

  randomMood(){
    return this.randomPick(["Emotional","Dark Pop","Summer Vibes","Melancholic","Upbeat","Romantic"])
  }

  // ---------- ARTIST LOCK ----------
  lockArtist(name){
    this.artistLock = name
  }

  unlockArtist(){
    this.artistLock = null
  }

  getArtist(input){
    if(this.artistLock) return this.artistLock
    return input || "AI Generated Artist"
  }

  // ---------- RHYME PATTERN ----------
  rhymePattern(type){
    const patterns = {
      AABB: ["a","a","b","b"],
      ABAB: ["a","b","a","b"],
      AAAA: ["a","a","a","a"]
    }
    return patterns[type] || patterns.AABB
  }

  // ---------- SMART RHYME (LIGHTWEIGHT) ----------
  smartRhyme(baseLine, pattern){
    const endings = {
      a: ["ใจ","ไป","ไกล","ใหม่"],
      b: ["คืน","ฝืน","ยืน","ชื่น"]
    }
    return pattern.map(p=>{
      const word = this.randomPick(endings[p])
      return baseLine+" "+word
    }).join("\n")
  }

  // ---------- LYRICS GENERATOR ----------
  generateLyrics({original, mood, patternType}){

    const cacheKey = original+mood+patternType
    if(this.cache.has(cacheKey)) return this.cache.get(cacheKey)

    const pattern = this.rhymePattern(patternType)

    let lyrics

    if(original){
      lyrics = this.smartRhyme(original, pattern)
    } else {
      const seed = mood || this.randomMood()
      lyrics = this.smartRhyme("ในคืนที่ "+seed, pattern)
    }

    this.cache.set(cacheKey, lyrics)
    return lyrics
  }

  // ---------- ALGORITHM PROOF REWRITE ----------
  rewriteAlgorithmProof(text){
    return text.split("\n").map(line=>{
      return line.replace("รัก","โอบกอด").replace("ใจ","หัวใจ")
    }).join("\n")
  }

  // ---------- FULL BUILD ----------
  buildSong({
    title,
    artist,
    lyrics,
    mood,
    pattern="AABB",
    rewrite=false
  }){

    const finalTitle = title || this.randomTitle()
    const finalArtist = this.getArtist(artist)
    const finalLyrics = this.generateLyrics({
      original: lyrics,
      mood: mood,
      patternType: pattern
    })

    const processedLyrics = rewrite
      ? this.rewriteAlgorithmProof(finalLyrics)
      : finalLyrics
